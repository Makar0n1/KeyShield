<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KeyShield Admin Panel</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="/images/logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .auth-container {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      max-width: 420px;
      width: 100%;
      padding: 32px 28px;
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(18px);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .auth-logo {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #1d4ed8 35%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 14px;
      box-shadow: 0 18px 45px rgba(37, 99, 235, 0.6);
    }

    .auth-logo span {
      font-size: 26px;
      font-weight: 800;
      color: #e5e7eb;
    }

    .auth-header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
      margin-bottom: 6px;
    }

    .auth-header p {
      font-size: 13px;
      color: #9ca3af;
    }

    .role-switcher {
      display: flex;
      gap: 8px;
      padding: 4px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 24px;
    }

    .role-switcher button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
      transition: all 0.18s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .role-switcher button span.icon {
      font-size: 14px;
    }

    .role-switcher button.active {
      background: radial-gradient(circle at 20% 0, #38bdf8 0, #1d4ed8 45%, #1e293b 100%);
      color: #e5e7eb;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.7);
    }

    .role-switcher button:not(.active):hover {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 13px;
      color: #9ca3af;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper input {
      width: 100%;
      padding: 9px 12px 9px 34px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    .input-wrapper input::placeholder {
      color: #6b7280;
    }

    .input-wrapper input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.6), 0 18px 35px rgba(15, 23, 42, 0.9);
      background: rgba(15, 23, 42, 0.95);
    }

    .input-wrapper .icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #6b7280;
    }

    .login-button {
      margin-top: 6px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 20% 0, #38bdf8 0, #2563eb 40%, #1d4ed8 100%);
      color: #f9fafb;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.85);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .login-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 22px 50px rgba(37, 99, 235, 0.95);
    }

    .login-button:active {
      transform: translateY(0);
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.9);
    }

    .login-button.loading {
      opacity: 0.8;
      cursor: wait;
    }

    .helper-text {
      margin-top: 12px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      line-height: 1.5;
    }

    .helper-text span {
      color: #9ca3af;
    }

    .error-message {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      background: rgba(220, 38, 38, 0.12);
      border: 1px solid rgba(220, 38, 38, 0.5);
      color: #fecaca;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #2563eb 45%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 16px 40px rgba(37, 99, 235, 0.9);
    }

    .logo span {
      font-size: 22px;
      font-weight: 800;
      color: #e5e7eb;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .header p {
      font-size: 13px;
      color: #9ca3af;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #9ca3af;
    }

    .badge {
      background: rgba(37, 99, 235, 0.15);
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(59, 130, 246, 0.6);
      font-size: 12px;
      color: #bfdbfe;
    }

    .main-container {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 20px 18px;
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(16px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

        .finance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card.profit-positive .value {
      color: #22c55e;
    }

    .stat-card.profit-negative .value {
      color: #ef4444;
    }

    .stat-card {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #e5e7eb;
    }

    .stat-card p {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 8px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
      transition: all 0.15s ease;
    }

    .tab.active {
      background: rgba(37, 99, 235, 0.18);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.7);
    }

    .tab:hover {
      color: #e2e8f0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .table-container {
      background: #1e293b;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      overflow: hidden;
    }

    .table-toolbar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filter-group label {
      font-size: 13px;
      color: #9ca3af;
    }

    .filter-group select,
    .filter-group input {
      background: #020617;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      min-width: 120px;
    }

    .filter-group input::placeholder {
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
    }

    th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-size: 12px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    tbody tr:hover {
      background: rgba(17, 24, 39, 0.95);
    }

    .status-badge {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .status-created {
      background: rgba(148, 163, 184, 0.18);
      color: #e5e7eb;
    }

    .status-waiting {
      background: rgba(234, 179, 8, 0.08);
      color: #facc15;
    }

    .status-locked {
      background: rgba(59, 130, 246, 0.12);
      color: #93c5fd;
    }

    .status-in_progress {
      background: rgba(37, 99, 235, 0.22);
      color: #bfdbfe;
    }

    .status-completed {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .status-dispute {
      background: rgba(249, 115, 22, 0.15);
      color: #fed7aa;
    }

    .status-expired {
      background: rgba(148, 163, 184, 0.18);
      color: #cbd5f5;
    }

    .status-refunded {
      background: rgba(59, 130, 246, 0.12);
      color: #93c5fd;
    }

    .status-cancelled {
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
    }

    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: rgba(148, 163, 184, 0.15);
    }

    .btn-primary {
      border-color: rgba(59, 130, 246, 0.9);
      color: #bfdbfe;
    }

    .btn-primary:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .btn-danger {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.16);
    }

    .partners-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .partner-card {
      background: #0f172a;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .partner-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .partner-name {
      font-weight: 600;
      font-size: 14px;
      color: #e5e7eb;
    }

    .partner-domain {
      font-size: 12px;
      color: #9ca3af;
    }

    .partner-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .partner-stat-item {
      padding: 4px 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .partner-commission {
      font-weight: 600;
      color: #22c55e;
    }

    .partner-deals {
      font-size: 12px;
      color: #9ca3af;
    }

    .partner-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
    }

    .pagination {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 10px 12px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
    }

    .pagination button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      min-width: 70px;
    }

    .pagination button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .loading {
      padding: 20px;
      text-align: center;
      color: #9ca3af;
      font-size: 14px;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.85);
      z-index: 50;
      padding: 16px;
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      background: #020617;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 18px 18px 14px;
      max-width: 720px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.95);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .modal-header h2 {
      font-size: 18px;
      color: #e5e7eb;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      color: #9ca3af;
      cursor: pointer;
    }

    .modal-body {
      font-size: 13px;
      color: #e5e7eb;
    }

    .modal-body section {
      margin-bottom: 14px;
    }

    .modal-body h3 {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .modal-body p {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .modal-body ul {
      padding-left: 18px;
      margin-bottom: 10px;
    }

    .modal-body li {
      margin-bottom: 4px;
      color: #cbd5f5;
    }

    .platform-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 8px;
    }

    .platform-stat-card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 10px;
    }

    .platform-stat-card h4 {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .platform-stat-card p {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 0;
    }

    .platform-meta {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(30, 64, 175, 0.8);
      font-size: 12px;
      color: #9ca3af;
    }

    .platform-meta strong {
      color: #e5e7eb;
    }

    .dispute-extra {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px 12px;
      margin-top: 8px;
    }

    .dispute-extra h4 {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .dispute-extra p {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .badge-small {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #cbd5f5;
    }

    .logs-container {
      background: #020617;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #e5e7eb;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      background-image: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.07) 0, transparent 50%);
    }

    .login-back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .login-back-button:hover {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    @media (max-width: 1024px) {
      .dashboard {
        padding: 16px;
      }

      .main-container {
        padding: 16px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .header h1 {
        font-size: 22px;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 12px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header .user-info {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }

      .stats-grid,
      .finance-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 14px;
      }

      .table-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
        justify-content: space-between;
      }

      .filter-group select,
      .filter-group input {
        flex: 1;
      }

      .modal-content {
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .dashboard {
        padding: 10px;
      }

      .main-container {
        padding: 12px;
        border-radius: 20px;
      }

      .header h1 {
        font-size: 18px;
      }

      .stat-card {
        padding: 16px;
        margin: -16px -16px 16px -16px;
      }

      .stat-card .value {
        font-size: 24px;
      }

      .modal-content {
        width: 100%;
        margin: 0 12px;
        max-height: 90vh;
      }
    }
  
  </style>
</head>
<body>
  <div id="loginPage" class="login-page">
    <div class="auth-container">
      <button class="login-back-button" id="backToRoleBtn" style="display: none;">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ä–æ–ª–∏
      </button>
      <div class="auth-header">
        <div class="auth-logo">
          <span>K</span>
        </div>
        <h1>KeyShield</h1>
        <p>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞—Ä–±–∏—Ç—Ä–∞–∂ —Å–¥–µ–ª–æ–∫ –≤ TRC-20</p>
      </div>

      <div class="role-switcher" id="roleSwitcher">
        <button id="adminRoleBtn" class="active">
          <span class="icon">üõ°Ô∏è</span>
          –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        </button>
        <button id="partnerRoleBtn">
          <span class="icon">ü§ù</span>
          –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç
        </button>
      </div>

      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label class="form-label" for="username">–õ–æ–≥–∏–Ω</label>
          <div class="input-wrapper">
            <span class="icon">üë§</span>
            <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
          <div class="input-wrapper">
            <span class="icon">üîí</span>
            <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          </div>
        </div>

        <button type="submit" class="login-button" id="loginButton">
          –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
        </button>

        <div id="loginError" class="error-message"></div>

        <p class="helper-text">
          <span>KeyShield</span> ‚Äî —Å–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ —Å –º—É–ª—å—Ç–∏—Å–∏–≥-–∫–æ—à–µ–ª—å–∫–∞–º–∏ TRC-20. 
          –î–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.
        </p>
      </form>
    </div>
  </div>

  <div id="adminDashboard" style="display: none;">
    <div class="dashboard">
      <div class="header">
        <div class="header-left">
          <div class="logo">
            <span>K</span>
          </div>
          <div>
            <h1>KeyShield Admin</h1>
            <p>–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</p>
          </div>
        </div>
        <div class="user-info">
          <span id="currentUser"></span>
          <span class="badge">ADMIN</span>
          <button class="btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="main-container">
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Deals</h3>
            <div class="value" id="statTotalDeals">-</div>
          </div>
          <div class="stat-card">
            <h3>Active Deals</h3>
            <div class="value" id="statActiveDeals">-</div>
          </div>
          <div class="stat-card">
            <h3>Completed Deals</h3>
            <div class="value" id="statCompletedDeals">-</div>
          </div>
          <div class="stat-card">
            <h3>Open Disputes</h3>
            <div class="value" id="statOpenDisputes">-</div>
          </div>
          <div class="stat-card">
            <h3>Total Users</h3>
            <div class="value" id="statTotalUsers">-</div>
          </div>
          <div class="stat-card">
            <h3>Total Commission</h3>
            <div class="value" id="statTotalCommissions">-</div>
          </div>
        </div>

        <!-- Finance Overview -->
        <div class="finance-grid">
          <div class="stat-card">
            <h3>Gross Revenue (Commissions)</h3>
            <div class="value" id="statGrossRevenue">-</div>
            <p>Total commissions earned by the service</p>
          </div>
          <div class="stat-card">
            <h3>Expenses (TRX Costs)</h3>
            <div class="value" id="statExpensesUsdt">-</div>
            <p><span id="statExpensesTrx">-</span> TRX ¬∑ rate 0.28 USDT</p>
          </div>
          <div class="stat-card" id="netProfitCard">
            <h3>Net Profit</h3>
            <div class="value" id="statNetProfit">-</div>
            <p>Gross revenue minus TRX costs</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('deals')">Deals</button>
          <button class="tab" onclick="switchTab('partners')">Partners</button>
          <button class="tab" onclick="switchTab('disputes')">Disputes</button>
          <button class="tab" onclick="switchTab('logs')">Logs</button>
        </div>

        <!-- Deals Tab -->
        <div id="dealsTab" class="tab-content active">
          <div class="table-container">
            <div class="table-toolbar">
              <div class="filter-group">
                <label for="dealStatusFilter">Status:</label>
                <select id="dealStatusFilter" onchange="loadDeals(1)">
                  <option value="">All</option>
                  <option value="created">Created</option>
                  <option value="waiting_for_seller_wallet">Waiting seller wallet</option>
                  <option value="waiting_for_buyer_wallet">Waiting buyer wallet</option>
                  <option value="waiting_for_deposit">Waiting deposit</option>
                  <option value="locked">Locked</option>
                  <option value="in_progress">In progress</option>
                  <option value="completed">Completed</option>
                  <option value="dispute">Dispute</option>
                  <option value="expired">Expired</option>
                  <option value="refunded">Refunded</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="dealSearch">Search:</label>
                <input type="text" id="dealSearch" placeholder="ID, users, asset..." oninput="debouncedLoadDeals()">
              </div>
            </div>
            <div id="dealsLoading" class="loading" style="display: none;">Loading deals...</div>
            <table id="dealsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Users</th>
                  <th>Asset</th>
                  <th>Amount</th>
                  <th>Commission</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Deadline</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="dealsTableBody"></tbody>
            </table>
            <div class="pagination">
              <button id="prevDealsPage" onclick="changeDealsPage(-1)">Prev</button>
              <button id="nextDealsPage" onclick="changeDealsPage(1)">Next</button>
            </div>
          </div>
        </div>

        <!-- Partners Tab -->
        <div id="partnersTab" class="tab-content">
          <div class="table-toolbar">
            <div class="filter-group">
              <label>Partner:</label>
              <input type="text" id="partnerSearch" placeholder="Name, domain..." oninput="filterPartners()">
            </div>
            <button class="btn btn-primary" onclick="loadPartners()">Reload</button>
          </div>
          <div id="partnersLoading" class="loading" style="display:none;">Loading partners...</div>
          <div id="partnersGrid" class="partners-grid"></div>
        </div>

        <!-- Disputes Tab -->
        <div id="disputesTab" class="tab-content">
          <div class="table-container">
            <div class="table-toolbar">
              <div class="filter-group">
                <label for="disputeStatusFilter">Status:</label>
                <select id="disputeStatusFilter" onchange="loadDisputes(1)">
                  <option value="">All</option>
                  <option value="open">Open</option>
                  <option value="resolved">Resolved</option>
                </select>
              </div>
            </div>
            <div id="disputesLoading" class="loading" style="display:none;">Loading disputes...</div>
            <table id="disputesTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Deal</th>
                  <th>Opened by</th>
                  <th>Status</th>
                  <th>Opened at</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="disputesTableBody"></tbody>
            </table>
            <div class="pagination">
              <button id="prevDisputesPage" onclick="changeDisputesPage(-1)">Prev</button>
              <button id="nextDisputesPage" onclick="changeDisputesPage(1)">Next</button>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div id="logsTab" class="tab-content">
          <div class="table-toolbar">
            <div class="filter-group">
              <label for="logLines">Last lines:</label>
              <input type="number" id="logLines" value="200" min="50" max="2000">
            </div>
            <button class="btn btn-primary" onclick="loadLogs()">Reload</button>
          </div>
          <div id="logsLoading" class="loading" style="display:none;">Loading logs...</div>
          <div id="logsContainer" class="logs-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Deal Modal -->
  <div id="dealModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Deal Details</h2>
        <button class="modal-close" onclick="closeDealModal()">‚úï</button>
      </div>
      <div class="modal-body" id="dealModalBody">
        <!-- Content populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Partner Modal -->
  <div id="partnerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Partner Details</h2>
        <button class="modal-close" onclick="closePartnerModal()">‚úï</button>
      </div>
      <div class="modal-body" id="partnerModalBody">
        <!-- Content populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Dispute Modal -->
  <div id="disputeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Dispute Details</h2>
        <button class="modal-close" onclick="closeDisputeModal()">‚úï</button>
      </div>
      <div class="modal-body" id="disputeModalBody">
        <!-- Content populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const TRX_TO_USDT_RATE = 0.28; // Fixed TRX ‚Üí USDT rate for profit calculations
    let authCredentials = localStorage.getItem('adminAuth');
    let currentDealsPage = 1;
    let currentDisputesPage = 1;
    let dealsSearchTimeout = null;
    let role = 'admin';

    function base64Encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function init() {
      const savedRole = localStorage.getItem('adminRole');
      if (savedRole) {
        role = savedRole;
        updateRoleUI();
      }

      if (authCredentials && savedRole) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('currentUser').textContent = `Logged in as: ${savedRole}`;
        loadDashboardData();
        loadDeals();
        loadPartners();
        loadDisputes();
        loadLogs();
      }

      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('adminRoleBtn').addEventListener('click', () => setRole('admin'));
      document.getElementById('partnerRoleBtn').addEventListener('click', () => setRole('partner'));
    }

    function setRole(newRole) {
      role = newRole;
      localStorage.setItem('adminRole', role);
      updateRoleUI();
    }

    function updateRoleUI() {
      const adminBtn = document.getElementById('adminRoleBtn');
      const partnerBtn = document.getElementById('partnerRoleBtn');
      const headerTitle = document.querySelector('.auth-header h1');
      const headerSubtitle = document.querySelector('.auth-header p');

      if (role === 'admin') {
        adminBtn.classList.add('active');
        partnerBtn.classList.remove('active');
        headerTitle.textContent = 'KeyShield Admin';
        headerSubtitle.textContent = '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–∞';
      } else {
        partnerBtn.classList.add('active');
        adminBtn.classList.remove('active');
        headerTitle.textContent = 'KeyShield Partner';
        headerSubtitle.textContent = '–í—Ö–æ–¥ –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç –ø–ª–æ—â–∞–¥–∫–∏';
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('loginError');
      const loginButton = document.getElementById('loginButton');

      errorEl.classList.remove('visible');
      errorEl.textContent = '';

      if (!username || !password) {
        errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
        errorEl.classList.add('visible');
        return;
      }

      const endpoint = role === 'admin' ? '/admin/ping' : '/partner/ping';
      const credentials = base64Encode(`${username}:${password}`);

      loginButton.classList.add('loading');
      loginButton.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: { 'Authorization': `Basic ${credentials}` }
        });

        if (!response.ok) {
          throw new Error(`Login failed with status ${response.status}`);
        }

        authCredentials = credentials;
        localStorage.setItem('adminAuth', authCredentials);
        localStorage.setItem('adminUsername', username);

        document.getElementById('currentUser').textContent =
          role === 'admin'
            ? `Logged in as: ${username}`
            : `Partner: ${username}`;

        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';

        loadDashboardData();
        loadDeals();
        loadPartners();
        loadDisputes();
        loadLogs();
      } catch (error) {
        errorEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å, –ª–∏–±–æ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É.';
        errorEl.classList.add('visible');
        console.error(error);
      } finally {
        loginButton.classList.remove('loading');
        loginButton.textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
      }
    }

    function handleLogout() {
      authCredentials = null;
      localStorage.removeItem('adminAuth');
      localStorage.removeItem('adminUsername');
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
    }

    async function loadDashboardData() {
      try {
        const response = await fetch(`${API_BASE}/admin/stats`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });

        const data = await response.json();

        // Basic counters
        document.getElementById('statTotalDeals').textContent = data.deals.total;
        document.getElementById('statActiveDeals').textContent = data.deals.active;
        document.getElementById('statCompletedDeals').textContent = data.deals.completed;
        document.getElementById('statOpenDisputes').textContent = data.deals.disputed;
        document.getElementById('statTotalUsers').textContent = data.users.total;

        // Finance block ‚Äì expenses, gross revenue, net profit
        const finance = data.finance || {};
        const totalCommissionRaw = finance.totalCommission ?? 0;
        const totalCommission = typeof totalCommissionRaw === 'number'
          ? totalCommissionRaw
          : parseFloat(totalCommissionRaw) || 0;

        // Try to get total TRX spent; if only USDT value is available ‚Äì convert back
        let totalTrxSpent = 0;
        if (finance.totalTrxSpent != null) {
          totalTrxSpent = typeof finance.totalTrxSpent === 'number'
            ? finance.totalTrxSpent
            : parseFloat(finance.totalTrxSpent) || 0;
        } else if (finance.totalTrxSpentUsdt != null) {
          const spentUsdt = typeof finance.totalTrxSpentUsdt === 'number'
            ? finance.totalTrxSpentUsdt
            : parseFloat(finance.totalTrxSpentUsdt) || 0;
          totalTrxSpent = spentUsdt / TRX_TO_USDT_RATE;
        }

        const expensesUsdt = totalTrxSpent * TRX_TO_USDT_RATE;
        const grossRevenue = totalCommission;
        const netProfit = grossRevenue - expensesUsdt;

        // Old card: keep showing total commission as gross revenue
        const totalCommEl = document.getElementById('statTotalCommissions');
        if (totalCommEl) {
          totalCommEl.textContent = grossRevenue.toFixed(2) + ' USDT';
        }

        // New finance cards
        const grossEl = document.getElementById('statGrossRevenue');
        const expensesTrxEl = document.getElementById('statExpensesTrx');
        const expensesUsdtEl = document.getElementById('statExpensesUsdt');
        const netProfitEl = document.getElementById('statNetProfit');
        const netProfitCard = document.getElementById('netProfitCard');

        if (grossEl) {
          grossEl.textContent = grossRevenue.toFixed(2) + ' USDT';
        }
        if (expensesTrxEl) {
          expensesTrxEl.textContent = totalTrxSpent.toFixed(2);
        }
        if (expensesUsdtEl) {
          expensesUsdtEl.textContent = expensesUsdt.toFixed(2) + ' USDT';
        }
        if (netProfitEl && netProfitCard) {
          netProfitEl.textContent = netProfit.toFixed(2) + ' USDT';
          netProfitCard.classList.remove('profit-positive', 'profit-negative');
          if (netProfit > 0) {
            netProfitCard.classList.add('profit-positive');
          } else if (netProfit < 0) {
            netProfitCard.classList.add('profit-negative');
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
      }
    }

    async function loadDeals(page = 1) {
      const status = document.getElementById('dealStatusFilter').value;
      const params = new URLSearchParams({ limit: 50, skip: (page - 1) * 50 });
      if (status) params.append('status', status);

      document.getElementById('dealsLoading').style.display = 'block';
      document.getElementById('dealsTable').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/admin/deals?${params}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const data = await response.json();

        const tbody = document.getElementById('dealsTableBody');
        tbody.innerHTML = '';

        data.deals.forEach(deal => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${deal.dealId}</td>
            <td>${deal.buyer.username} / ${deal.seller.username}</td>
            <td>${deal.asset}</td>
            <td>${deal.amount}</td>
            <td>${deal.commission}</td>
            <td><span class="status-badge status-${deal.status}">${deal.status}</span></td>
            <td>${new Date(deal.createdAt).toLocaleString()}</td>
            <td>${deal.deadline ? new Date(deal.deadline).toLocaleString() : '-'}</td>
            <td class="actions">
              <button class="btn btn-primary" onclick="showDealDetails('${deal._id}')">View</button>
              <button class="btn btn-danger" onclick="cancelDeal('${deal._id}')">Cancel</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        currentDealsPage = page;
        document.getElementById('dealsLoading').style.display = 'none';
        document.getElementById('dealsTable').style.display = '';
        document.getElementById('prevDealsPage').disabled = page === 1;
        document.getElementById('nextDealsPage').disabled = data.deals.length < 50;
      } catch (error) {
        console.error('Failed to load deals:', error);
        document.getElementById('dealsLoading').textContent = 'Failed to load deals';
      }
    }

    function changeDealsPage(delta) {
      const newPage = currentDealsPage + delta;
      if (newPage < 1) return;
      loadDeals(newPage);
    }

    function debouncedLoadDeals() {
      if (dealsSearchTimeout) clearTimeout(dealsSearchTimeout);
      dealsSearchTimeout = setTimeout(() => loadDeals(1), 400);
    }

    async function showDealDetails(id) {
      try {
        const response = await fetch(`${API_BASE}/admin/deals/${id}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const deal = await response.json();

        const modalBody = document.getElementById('dealModalBody');
        modalBody.innerHTML = `
          <section>
            <h3>Basic Info</h3>
            <p><strong>ID:</strong> ${deal.dealId}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${deal.status}">${deal.status}</span></p>
            <p><strong>Asset:</strong> ${deal.asset}</p>
            <p><strong>Amount:</strong> ${deal.amount}</p>
            <p><strong>Commission:</strong> ${deal.commission} ${deal.asset}</p>
          </section>
          <section>
            <h3>Participants</h3>
            <p><strong>Buyer:</strong> ${deal.buyer.username} (${deal.buyer.telegramId})</p>
            <p><strong>Seller:</strong> ${deal.seller.username} (${deal.seller.telegramId})</p>
          </section>
          <section>
            <h3>Timing</h3>
            <p><strong>Created at:</strong> ${new Date(deal.createdAt).toLocaleString()}</p>
            <p><strong>Deadline:</strong> ${deal.deadline ? new Date(deal.deadline).toLocaleString() : '-'}</p>
          </section>
        `;

        document.getElementById('dealModal').classList.add('visible');
      } catch (error) {
        console.error('Failed to load deal details:', error);
      }
    }

    function closeDealModal() {
      document.getElementById('dealModal').classList.remove('visible');
    }

    async function cancelDeal(id) {
      if (!confirm('Are you sure you want to cancel this deal?')) return;

      try {
        const response = await fetch(`${API_BASE}/admin/deals/${id}/cancel`, {
          method: 'POST',
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });

        if (response.ok) {
          alert('Deal cancelled');
          loadDeals(currentDealsPage);
        } else {
          alert('Failed to cancel deal');
        }
      } catch (error) {
        console.error('Failed to cancel deal:', error);
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      document.getElementById(`${tabName}Tab`).classList.add('active');
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    }

    async function loadPartners() {
      document.getElementById('partnersLoading').style.display = 'block';
      const grid = document.getElementById('partnersGrid');
      grid.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/admin/platforms`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const data = await response.json();

        data.platforms.forEach(platform => {
          const card = document.createElement('div');
          card.className = 'partner-card';
          card.innerHTML = `
            <div class="partner-card-header">
              <div>
                <div class="partner-name">${platform.name}</div>
                <div class="partner-domain">${platform.domain}</div>
              </div>
              <div class="partner-commission">
                ${platform.stats.totalCommission.toFixed(2)} USDT
              </div>
            </div>
            <div class="partner-stats">
              <span class="partner-stat-item">Deals: ${platform.stats.dealsCount}</span>
              <span class="partner-stat-item">Completed: ${platform.stats.completedDeals}</span>
              <span class="partner-stat-item">Conversion: ${platform.stats.conversionRate.toFixed(1)}%</span>
              <span class="partner-stat-item">TRX spent: ${platform.stats.totalTrxSpent.toFixed(2)}</span>
            </div>
            <div class="partner-footer">
              <span>Last deal: ${platform.lastDealDate ? new Date(platform.lastDealDate).toLocaleDateString() : '‚Äî'}</span>
              <button class="btn btn-primary" onclick="showPartnerDetails('${platform._id}')">Details</button>
            </div>
          `;
          grid.appendChild(card);
        });

        document.getElementById('partnersLoading').style.display = 'none';
      } catch (error) {
        console.error('Failed to load partners:', error);
        document.getElementById('partnersLoading').textContent = 'Failed to load partners';
      }
    }

    function filterPartners() {
      const query = document.getElementById('partnerSearch').value.toLowerCase();
      const cards = document.querySelectorAll('.partner-card');
      cards.forEach(card => {
        const name = card.querySelector('.partner-name').textContent.toLowerCase();
        const domain = card.querySelector('.partner-domain').textContent.toLowerCase();
        card.style.display = name.includes(query) || domain.includes(query) ? '' : 'none';
      });
    }

    async function showPartnerDetails(id) {
      try {
        const response = await fetch(`${API_BASE}/admin/platforms/${id}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const platform = await response.json();

        const modalBody = document.getElementById('partnerModalBody');
        modalBody.innerHTML = `
          <section>
            <h3>Platform Info</h3>
            <div class="platform-details-grid">
              <div class="platform-stat-card">
                <h4>Name & Domain</h4>
                <p><strong>${platform.name}</strong><br>${platform.domain}</p>
              </div>
              <div class="platform-stat-card">
                <h4>Status</h4>
                <p>${platform.isActive ? 'Active' : 'Inactive'}</p>
              </div>
            </div>
          </section>
          <section>
            <h3>Performance</h3>
            <div class="platform-details-grid">
              <div class="platform-stat-card">
                <h4>Deals</h4>
                <p>Total: ${platform.stats.dealsCount}<br>Completed: ${platform.stats.completedDeals}</p>
              </div>
              <div class="platform-stat-card">
                <h4>Conversion</h4>
                <p>${platform.stats.conversionRate.toFixed(2)}%</p>
              </div>
            </div>
          </section>
          <section>
            <h3>Finance</h3>
            <div class="platform-details-grid">
              <div class="platform-stat-card">
                <h4>Commission (Gross)</h4>
                <p>${platform.stats.totalCommission.toFixed(2)} USDT</p>
              </div>
              <div class="platform-stat-card">
                <h4>TRX Spent</h4>
                <p>${platform.stats.totalTrxSpent.toFixed(2)} TRX<br>‚âà ${platform.stats.totalTrxSpentUsdt.toFixed(2)} USDT</p>
              </div>
              <div class="platform-stat-card">
                <h4>Net Profit</h4>
                <p>${platform.stats.netProfit.toFixed(2)} USDT</p>
              </div>
              <div class="platform-stat-card">
                <h4>Platform Earnings</h4>
                <p>${platform.stats.platformEarnings.toFixed(2)} USDT</p>
              </div>
            </div>
          </section>
          <section class="platform-meta">
            <p><strong>Created:</strong> ${new Date(platform.createdAt).toLocaleString()}</p>
            <p><strong>Last deal:</strong> ${platform.lastDealDate ? new Date(platform.lastDealDate).toLocaleString() : '‚Äî'}</p>
            <p><strong>Partner:</strong> ${platform.owner.username} (${platform.owner.telegramId})</p>
          </section>
        `;

        document.getElementById('partnerModal').classList.add('visible');
      } catch (error) {
        console.error('Failed to load partner details:', error);
      }
    }

    function closePartnerModal() {
      document.getElementById('partnerModal').classList.remove('visible');
    }

    async function loadDisputes(page = 1) {
      const status = document.getElementById('disputeStatusFilter').value;
      const params = new URLSearchParams({ limit: 50, skip: (page - 1) * 50 });
      if (status) params.append('status', status);

      document.getElementById('disputesLoading').style.display = 'block';
      document.getElementById('disputesTable').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/admin/disputes?${params}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const data = await response.json();

        const tbody = document.getElementById('disputesTableBody');
        tbody.innerHTML = '';

        data.disputes.forEach(dispute => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dispute._id}</td>
            <td>${dispute.dealId}</td>
            <td>${dispute.openedBy}</td>
            <td><span class="status-badge status-${dispute.status}">${dispute.status}</span></td>
            <td>${new Date(dispute.createdAt).toLocaleString()}</td>
            <td class="actions">
              <button class="btn btn-primary" onclick="showDisputeDetails('${dispute._id}')">View</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        currentDisputesPage = page;
        document.getElementById('disputesLoading').style.display = 'none';
        document.getElementById('disputesTable').style.display = '';
        document.getElementById('prevDisputesPage').disabled = page === 1;
        document.getElementById('nextDisputesPage').disabled = data.disputes.length < 50;
      } catch (error) {
        console.error('Failed to load disputes:', error);
        document.getElementById('disputesLoading').textContent = 'Failed to load disputes';
      }
    }

    function changeDisputesPage(delta) {
      const newPage = currentDisputesPage + delta;
      if (newPage < 1) return;
      loadDisputes(newPage);
    }

    async function showDisputeDetails(id) {
      try {
        const response = await fetch(`${API_BASE}/admin/disputes/${id}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const dispute = await response.json();

        const modalBody = document.getElementById('disputeModalBody');
        modalBody.innerHTML = `
          <section>
            <h3>Dispute Info</h3>
            <p><strong>ID:</strong> ${dispute._id}</p>
            <p><strong>Deal:</strong> ${dispute.dealId}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${dispute.status}">${dispute.status}</span></p>
            <p><strong>Opened by:</strong> ${dispute.openedBy}</p>
            <p><strong>Created at:</strong> ${new Date(dispute.createdAt).toLocaleString()}</p>
          </section>
          <section>
            <h3>Reason & Evidence</h3>
            <p><strong>Reason:</strong> ${dispute.reason}</p>
            <p><strong>Evidence count:</strong> ${dispute.evidence.length}</p>
          </section>
          <section>
            <h3>Resolution</h3>
            <p><strong>Resolution:</strong> ${dispute.resolution || 'Not resolved yet'}</p>
          </section>
        `;

        document.getElementById('disputeModal').classList.add('visible');
      } catch (error) {
        console.error('Failed to load dispute details:', error);
      }
    }

    function closeDisputeModal() {
      document.getElementById('disputeModal').classList.remove('visible');
    }

    async function loadLogs() {
      const lines = document.getElementById('logLines').value;
      document.getElementById('logsLoading').style.display = 'block';
      document.getElementById('logsContainer').textContent = '';

      try {
        const response = await fetch(`${API_BASE}/admin/logs?lines=${lines}`, {
          headers: { 'Authorization': `Basic ${authCredentials}` }
        });
        const data = await response.json();

        document.getElementById('logsContainer').textContent = data.logs;
        document.getElementById('logsLoading').style.display = 'none';
      } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('logsLoading').textContent = 'Failed to load logs';
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>

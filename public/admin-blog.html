<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KeyShield Blog Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="/images/logo.png">
  <!-- Quill Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-box {
      background: #1e293b;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 400px;
    }
    .login-box h1 {
      margin-bottom: 30px;
      font-size: 28px;
      text-align: center;
      color: #60a5fa;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #cbd5e1;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #334155;
      border-radius: 6px;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #60a5fa;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #475569; color: white; }
    .btn-secondary:hover { background: #334155; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .dashboard { display: none; padding: 20px; }
    .dashboard.active { display: block; }

    .header {
      background: #1e293b;
      padding: 20px;
      margin: -20px -20px 20px -20px;
      border-bottom: 2px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { color: #60a5fa; font-size: 24px; }
    .header-nav { display: flex; gap: 15px; align-items: center; }
    .header-nav a {
      color: #94a3b8;
      text-decoration: none;
      font-weight: 500;
    }
    .header-nav a:hover { color: #60a5fa; }
    .btn-logout { background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-logout:hover { background: #b91c1c; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .stat-card h3 { font-size: 12px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
    .stat-card .value { font-size: 28px; font-weight: bold; color: #60a5fa; }
    .stat-card.success { border-left-color: #10b981; }
    .stat-card.success .value { color: #10b981; }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.warning .value { color: #f59e0b; }
    .stat-card.danger { border-left-color: #ef4444; }
    .stat-card.danger .value { color: #ef4444; }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #334155;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    .tab:hover { color: #e2e8f0; }
    .tab .badge-count {
      background: #ef4444;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .table-container { background: #1e293b; border-radius: 8px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th {
      background: #0f172a;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      color: #cbd5e1;
      border-bottom: 2px solid #334155;
      font-size: 13px;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #334155;
      color: #e2e8f0;
      font-size: 14px;
    }
    tr:hover { background: #334155; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-success { background: #166534; color: #86efac; }
    .badge-warning { background: #854d0e; color: #fde047; }
    .badge-danger { background: #991b1b; color: #fca5a5; }
    .badge-info { background: #1e40af; color: #93c5fd; }
    .badge-secondary { background: #475569; color: #cbd5e1; }

    .loading { text-align: center; padding: 40px; color: #94a3b8; }
    .empty { text-align: center; padding: 40px; color: #64748b; }

    .filters {
      background: #1e293b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 12px; color: #94a3b8; }
    .filter-group input, .filter-group select {
      padding: 8px 12px;
      border: 1px solid #334155;
      border-radius: 6px;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 14px;
      min-width: 150px;
    }

    .action-btns { display: flex; gap: 5px; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal-content {
      background: #1e293b;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      margin: 40px 0;
      position: relative;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { color: #60a5fa; font-size: 20px; }
    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
    }
    .modal-close:hover { color: #ef4444; }
    .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #334155;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Quill Editor */
    .ql-toolbar.ql-snow { background: #0f172a; border-color: #334155; }
    .ql-container.ql-snow { border-color: #334155; background: #0f172a; }
    .ql-editor { min-height: 200px; color: #e2e8f0; font-size: 14px; }
    .ql-snow .ql-stroke { stroke: #94a3b8; }
    .ql-snow .ql-fill { fill: #94a3b8; }
    .ql-snow .ql-picker { color: #94a3b8; }
    .ql-snow .ql-picker-options { background: #1e293b; border-color: #334155; }
    .ql-editor.ql-blank::before { color: #64748b; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #334155;
    }
    .image-upload-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #475569;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .image-upload-btn:hover { background: #64748b; }
    .image-upload-btn input { display: none; }

    .tag-input-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .tag-chip {
      background: #3b82f6;
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tag-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }

    .faq-item {
      background: #0f172a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      position: relative;
    }
    .faq-item .remove-faq {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ef4444;
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
    }

    .link { color: #60a5fa; text-decoration: none; }
    .link:hover { text-decoration: underline; }

    .truncate {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Media Gallery */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .media-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .media-item:hover { border-color: #3b82f6; }
    .media-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .media-item .delete-media {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ef4444;
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .media-item:hover .delete-media { opacity: 1; }
    .media-item .copy-url {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: #3b82f6;
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .media-item:hover .copy-url { opacity: 1; }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    .notification.error { background: #ef4444; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <h1>üîê Blog Admin</h1>
      <form onsubmit="login(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>üìù Blog Admin</h1>
      <div class="header-nav">
        <a href="/admin">‚Üê Main Admin</a>
        <a href="/blog" target="_blank">View Blog</a>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Total Posts</h3>
        <div class="value" id="statPosts">-</div>
      </div>
      <div class="stat-card success">
        <h3>Published</h3>
        <div class="value" id="statPublished">-</div>
      </div>
      <div class="stat-card warning">
        <h3>Drafts</h3>
        <div class="value" id="statDrafts">-</div>
      </div>
      <div class="stat-card">
        <h3>Categories</h3>
        <div class="value" id="statCategories">-</div>
      </div>
      <div class="stat-card">
        <h3>Tags</h3>
        <div class="value" id="statTags">-</div>
      </div>
      <div class="stat-card danger">
        <h3>Pending Comments</h3>
        <div class="value" id="statPendingComments">-</div>
      </div>
      <div class="stat-card">
        <h3>Total Views</h3>
        <div class="value" id="statViews">-</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('posts')">Posts</button>
      <button class="tab" onclick="switchTab('categories')">Categories</button>
      <button class="tab" onclick="switchTab('tags')">Tags</button>
      <button class="tab" onclick="switchTab('comments')" id="commentsTab">Comments</button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
      <button class="tab" onclick="switchTab('media')">Media</button>
    </div>

    <!-- Posts Tab -->
    <div id="postsTabContent" class="tab-content active">
      <div class="filters">
        <div class="filter-group">
          <label>Status</label>
          <select id="postStatusFilter" onchange="loadPosts()">
            <option value="">All</option>
            <option value="published">Published</option>
            <option value="draft">Draft</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Category</label>
          <select id="postCategoryFilter" onchange="loadPosts()">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="postSearchInput" placeholder="Search posts..." onkeyup="debounce(loadPosts, 300)()">
        </div>
        <button class="btn btn-success" onclick="openPostModal()">+ New Post</button>
      </div>
      <div class="table-container">
        <div id="postsLoading" class="loading">Loading posts...</div>
        <table id="postsTable" style="display: none;">
          <thead>
            <tr>
              <th>Title</th>
              <th>Category</th>
              <th>Status</th>
              <th>Views</th>
              <th>Comments</th>
              <th>Published</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="postsTableBody"></tbody>
        </table>
        <div id="postsEmpty" class="empty" style="display: none;">No posts found</div>
      </div>
    </div>

    <!-- Categories Tab -->
    <div id="categoriesTabContent" class="tab-content">
      <div class="filters">
        <button class="btn btn-success" onclick="openCategoryModal()">+ New Category</button>
      </div>
      <div class="table-container">
        <div id="categoriesLoading" class="loading">Loading categories...</div>
        <table id="categoriesTable" style="display: none;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Slug</th>
              <th>Posts</th>
              <th>Order</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="categoriesTableBody"></tbody>
        </table>
        <div id="categoriesEmpty" class="empty" style="display: none;">No categories yet</div>
      </div>
    </div>

    <!-- Tags Tab -->
    <div id="tagsTabContent" class="tab-content">
      <div class="filters">
        <button class="btn btn-success" onclick="openTagModal()">+ New Tag</button>
      </div>
      <div class="table-container">
        <div id="tagsLoading" class="loading">Loading tags...</div>
        <table id="tagsTable" style="display: none;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Slug</th>
              <th>Posts</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tagsTableBody"></tbody>
        </table>
        <div id="tagsEmpty" class="empty" style="display: none;">No tags yet</div>
      </div>
    </div>

    <!-- Comments Tab -->
    <div id="commentsTabContent" class="tab-content">
      <div class="filters">
        <div class="filter-group">
          <label>Status</label>
          <select id="commentStatusFilter" onchange="loadComments()">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="hidden">Hidden</option>
          </select>
        </div>
      </div>
      <div class="table-container">
        <div id="commentsLoading" class="loading">Loading comments...</div>
        <table id="commentsTable" style="display: none;">
          <thead>
            <tr>
              <th>Author</th>
              <th>Comment</th>
              <th>Post</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="commentsTableBody"></tbody>
        </table>
        <div id="commentsEmpty" class="empty" style="display: none;">No comments</div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTabContent" class="tab-content">
      <div class="table-container" style="padding: 20px;">
        <h3 style="margin-bottom: 20px; color: #60a5fa;">Blog Main Page Settings</h3>
        <form id="settingsForm" onsubmit="saveSettings(event)">
          <div class="form-row">
            <div class="form-group">
              <label>Blog Title</label>
              <input type="text" id="settingsTitle" maxlength="200">
            </div>
            <div class="form-group">
              <label>SEO Title</label>
              <input type="text" id="settingsSeoTitle" maxlength="70">
            </div>
          </div>
          <div class="form-group">
            <label>Description (Rich Text)</label>
            <div id="settingsDescriptionEditor"></div>
          </div>
          <div class="form-group">
            <label>SEO Description</label>
            <textarea id="settingsSeoDescription" rows="2" maxlength="160"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" id="settingsCoverImage">
              <img id="settingsCoverPreview" class="image-preview" style="display: none;">
            </div>
            <div class="form-group">
              <label>Cover Image Alt</label>
              <input type="text" id="settingsCoverImageAlt" maxlength="200">
            </div>
          </div>
          <div class="form-group">
            <label>Canonical URL</label>
            <input type="text" id="settingsCanonical" placeholder="https://keyshield.me/blog">
          </div>
          <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
      </div>
    </div>

    <!-- Media Tab -->
    <div id="mediaTabContent" class="tab-content">
      <div class="filters">
        <label class="image-upload-btn">
          üìÅ Upload Image
          <input type="file" accept="image/*" onchange="uploadMedia(event)">
        </label>
      </div>
      <div id="mediaLoading" class="loading">Loading media...</div>
      <div id="mediaGrid" class="media-grid" style="display: none;"></div>
      <div id="mediaEmpty" class="empty" style="display: none;">No media files</div>
    </div>
  </div>

  <!-- Post Modal -->
  <div class="modal" id="postModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="postModalTitle">New Post</h2>
        <button class="modal-close" onclick="closePostModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="postForm">
          <input type="hidden" id="postId">
          <div class="form-group">
            <label>Title *</label>
            <input type="text" id="postTitle" required maxlength="200">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Slug</label>
              <input type="text" id="postSlug" placeholder="auto-generated">
            </div>
            <div class="form-group">
              <label>Category *</label>
              <select id="postCategory" required>
                <option value="">Select category</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Summary</label>
            <textarea id="postSummary" rows="2" maxlength="500" placeholder="Brief description for cards"></textarea>
          </div>
          <div class="form-group">
            <label>Content</label>
            <div id="postContentEditor"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" id="postCoverImage" oninput="previewPostCover()">
              <img id="postCoverPreview" class="image-preview" style="display: none;">
            </div>
            <div class="form-group">
              <label>Cover Alt Text</label>
              <input type="text" id="postCoverImageAlt" maxlength="200">
            </div>
          </div>
          <div class="form-group">
            <label>Tags</label>
            <div class="tag-input-container" id="postTagsContainer"></div>
            <select id="postTagSelect" onchange="addTagToPost()" style="margin-top: 10px;">
              <option value="">Add tag...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>SEO Title</label>
              <input type="text" id="postSeoTitle" maxlength="70">
            </div>
            <div class="form-group">
              <label>SEO Description</label>
              <input type="text" id="postSeoDescription" maxlength="160">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Status</label>
              <select id="postStatus">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="form-group">
              <label>Publish Date</label>
              <input type="datetime-local" id="postPublishedAt">
            </div>
          </div>
          <div class="form-group">
            <label>FAQ Blocks (for Schema.org)</label>
            <div id="faqContainer"></div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addFaqBlock()">+ Add FAQ</button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePostModal()">Cancel</button>
        <button class="btn btn-primary" onclick="savePost()">Save Post</button>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <div class="modal" id="categoryModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 id="categoryModalTitle">New Category</h2>
        <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <input type="hidden" id="categoryId">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="categoryName" required maxlength="100">
            </div>
            <div class="form-group">
              <label>Slug</label>
              <input type="text" id="categorySlug" placeholder="auto-generated">
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <div id="categoryDescriptionEditor"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" id="categoryCoverImage">
            </div>
            <div class="form-group">
              <label>Cover Alt</label>
              <input type="text" id="categoryCoverImageAlt" maxlength="200">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>SEO Title</label>
              <input type="text" id="categorySeoTitle" maxlength="70">
            </div>
            <div class="form-group">
              <label>Sort Order</label>
              <input type="number" id="categorySortOrder" value="0">
            </div>
          </div>
          <div class="form-group">
            <label>SEO Description</label>
            <textarea id="categorySeoDescription" rows="2" maxlength="160"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCategory()">Save</button>
      </div>
    </div>
  </div>

  <!-- Tag Modal -->
  <div class="modal" id="tagModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 id="tagModalTitle">New Tag</h2>
        <button class="modal-close" onclick="closeTagModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="tagForm">
          <input type="hidden" id="tagId">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="tagName" required maxlength="50">
            </div>
            <div class="form-group">
              <label>Slug</label>
              <input type="text" id="tagSlug" placeholder="auto-generated">
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <div id="tagDescriptionEditor"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cover Image URL</label>
              <input type="text" id="tagCoverImage">
            </div>
            <div class="form-group">
              <label>Cover Alt</label>
              <input type="text" id="tagCoverImageAlt" maxlength="200">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>SEO Title</label>
              <input type="text" id="tagSeoTitle" maxlength="70">
            </div>
            <div class="form-group">
              <label>SEO Description</label>
              <input type="text" id="tagSeoDescription" maxlength="160">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTagModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTag()">Save</button>
      </div>
    </div>
  </div>

  <!-- Quill Editor JS -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    // Blog admin API is on the same origin (web server), not api.keyshield.me
    const API_BASE = '';
    let authToken = localStorage.getItem('blogAdminToken') || '';

    // Quill editors
    let postContentEditor = null;
    let categoryDescriptionEditor = null;
    let tagDescriptionEditor = null;
    let settingsDescriptionEditor = null;

    // Data
    let categories = [];
    let tags = [];
    let selectedPostTags = [];

    // Debounce
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Notification
    function showNotification(message, isError = false) {
      const el = document.createElement('div');
      el.className = 'notification' + (isError ? ' error' : '');
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // Auth - validate token on load
    async function validateToken() {
      if (!authToken) return false;
      try {
        // Use same origin for validation (web server has the JWT middleware)
        const res = await fetch(`/api/admin/blog/stats`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    async function login(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const submitBtn = e.target.querySelector('button[type="submit"]');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';

      try {
        // Login always goes to same origin (not API_BASE) since login endpoint is on web server
        const res = await fetch(`/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (res.ok && data.success && data.token) {
          authToken = data.token;
          localStorage.setItem('blogAdminToken', data.token);
          showDashboard();
        } else {
          alert(data.error || 'Invalid credentials');
        }
      } catch (err) {
        alert('Connection error: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    }

    function logout() {
      authToken = '';
      localStorage.removeItem('blogAdminToken');
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginContainer').style.display = 'flex';
    }

    // Helper for authenticated requests
    async function apiRequest(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          'Authorization': `Bearer ${authToken}`
        }
      });
      if (response.status === 401) {
        logout();
        throw new Error('Session expired');
      }
      return response;
    }

    async function showDashboard() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      initEditors();
      await Promise.all([loadStats(), loadCategories(), loadTags(), loadPosts(), loadSettings()]);
    }

    // Initialize Quill editors
    function initEditors() {
      if (postContentEditor) return;

      const toolbarOptions = [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
      ];

      postContentEditor = new Quill('#postContentEditor', {
        theme: 'snow',
        modules: { toolbar: toolbarOptions }
      });

      // Custom image handler for uploading to server instead of base64
      postContentEditor.getModule('toolbar').addHandler('image', function() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append('image', file);

          try {
            const res = await fetch(`${API_BASE}/api/admin/blog/upload`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${authToken}` },
              body: formData
            });

            const contentType = res.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              throw new Error('Server error. Please re-login.');
            }

            const data = await res.json();
            if (data.success) {
              const range = postContentEditor.getSelection(true);
              postContentEditor.insertEmbed(range.index, 'image', data.url);
              postContentEditor.setSelection(range.index + 1);
              showNotification('Image uploaded!');
            } else {
              throw new Error(data.error);
            }
          } catch (err) {
            showNotification(err.message, true);
          }
        };
      });

      categoryDescriptionEditor = new Quill('#categoryDescriptionEditor', {
        theme: 'snow',
        modules: { toolbar: toolbarOptions }
      });

      tagDescriptionEditor = new Quill('#tagDescriptionEditor', {
        theme: 'snow',
        modules: { toolbar: toolbarOptions }
      });

      settingsDescriptionEditor = new Quill('#settingsDescriptionEditor', {
        theme: 'snow',
        modules: { toolbar: toolbarOptions }
      });
    }

    // API calls
    async function apiCall(endpoint, options = {}) {
      const res = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    // Stats
    async function loadStats() {
      try {
        const { stats } = await apiCall('/api/admin/blog/stats');
        document.getElementById('statPosts').textContent = stats.posts;
        document.getElementById('statPublished').textContent = stats.published;
        document.getElementById('statDrafts').textContent = stats.drafts;
        document.getElementById('statCategories').textContent = stats.categories;
        document.getElementById('statTags').textContent = stats.tags;
        document.getElementById('statPendingComments').textContent = stats.pendingComments;
        document.getElementById('statViews').textContent = stats.totalViews.toLocaleString();

        // Update comments tab badge
        if (stats.pendingComments > 0) {
          document.getElementById('commentsTab').innerHTML = `Comments <span class="badge-count">${stats.pendingComments}</span>`;
        }
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`${tab}TabContent`).classList.add('active');

      if (tab === 'comments') loadComments();
      if (tab === 'media') loadMedia();
    }

    // --- POSTS ---
    async function loadPosts() {
      const status = document.getElementById('postStatusFilter').value;
      const category = document.getElementById('postCategoryFilter').value;
      const search = document.getElementById('postSearchInput').value;

      document.getElementById('postsLoading').style.display = 'block';
      document.getElementById('postsTable').style.display = 'none';
      document.getElementById('postsEmpty').style.display = 'none';

      try {
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (category) params.append('category', category);
        if (search) params.append('search', search);

        const { posts } = await apiCall(`/api/admin/blog/posts?${params}`);

        document.getElementById('postsLoading').style.display = 'none';

        if (posts.length === 0) {
          document.getElementById('postsEmpty').style.display = 'block';
          return;
        }

        document.getElementById('postsTable').style.display = 'table';
        const tbody = document.getElementById('postsTableBody');
        tbody.innerHTML = posts.map(post => `
          <tr>
            <td>
              <div class="truncate" title="${escapeHtml(post.title)}">${escapeHtml(post.title)}</div>
              <small style="color: #64748b;">${post.slug}</small>
            </td>
            <td>${post.category?.name || '-'}</td>
            <td>
              <span class="badge ${post.status === 'published' ? 'badge-success' : 'badge-warning'}">
                ${post.status}
              </span>
            </td>
            <td>${post.views}</td>
            <td>${post.commentsCount}</td>
            <td>${post.publishedAt ? new Date(post.publishedAt).toLocaleDateString('ru-RU') : '-'}</td>
            <td>
              <div class="action-btns">
                <button class="btn btn-primary btn-sm" onclick="editPost('${post._id}')">Edit</button>
                ${post.status === 'published' ? `<a href="/blog/${post.slug}" target="_blank" class="btn btn-secondary btn-sm">View</a>` : ''}
                <button class="btn btn-danger btn-sm" onclick="deletePost('${post._id}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading posts:', err);
        document.getElementById('postsLoading').textContent = 'Error loading posts';
      }
    }

    function openPostModal(post = null) {
      document.getElementById('postModalTitle').textContent = post ? 'Edit Post' : 'New Post';
      document.getElementById('postId').value = post?._id || '';
      document.getElementById('postTitle').value = post?.title || '';
      document.getElementById('postSlug').value = post?.slug || '';
      document.getElementById('postSummary').value = post?.summary || '';
      document.getElementById('postCoverImage').value = post?.coverImage || '';
      document.getElementById('postCoverImageAlt').value = post?.coverImageAlt || '';
      document.getElementById('postSeoTitle').value = post?.seoTitle || '';
      document.getElementById('postSeoDescription').value = post?.seoDescription || '';
      document.getElementById('postStatus').value = post?.status || 'draft';
      document.getElementById('postPublishedAt').value = post?.publishedAt ? new Date(post.publishedAt).toISOString().slice(0, 16) : '';

      // Category
      document.getElementById('postCategory').innerHTML = '<option value="">Select category</option>' +
        categories.map(c => `<option value="${c._id}" ${post?.category?._id === c._id ? 'selected' : ''}>${c.name}</option>`).join('');

      // Content
      postContentEditor.root.innerHTML = post?.content || '';

      // Tags
      selectedPostTags = post?.tags?.map(t => t._id) || [];
      renderPostTags();
      updateTagSelect();

      // FAQ
      document.getElementById('faqContainer').innerHTML = '';
      (post?.faq || []).forEach(f => addFaqBlock(f.question, f.answer));

      // Preview
      previewPostCover();

      document.getElementById('postModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePostModal() {
      document.getElementById('postModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    async function editPost(id) {
      try {
        const { post } = await apiCall(`/api/admin/blog/posts/${id}`);
        openPostModal(post);
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    async function savePost() {
      const id = document.getElementById('postId').value;
      const data = {
        title: document.getElementById('postTitle').value,
        slug: document.getElementById('postSlug').value || undefined,
        summary: document.getElementById('postSummary').value,
        content: postContentEditor.root.innerHTML,
        coverImage: document.getElementById('postCoverImage').value,
        coverImageAlt: document.getElementById('postCoverImageAlt').value,
        category: document.getElementById('postCategory').value,
        tags: selectedPostTags,
        seoTitle: document.getElementById('postSeoTitle').value,
        seoDescription: document.getElementById('postSeoDescription').value,
        status: document.getElementById('postStatus').value,
        publishedAt: document.getElementById('postPublishedAt').value || null,
        faq: getFaqData()
      };

      try {
        if (id) {
          await apiCall(`/api/admin/blog/posts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
        } else {
          await apiCall('/api/admin/blog/posts', { method: 'POST', body: JSON.stringify(data) });
        }
        showNotification('Post saved!');
        closePostModal();
        loadPosts();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    async function deletePost(id) {
      if (!confirm('Delete this post?')) return;
      try {
        await apiCall(`/api/admin/blog/posts/${id}`, { method: 'DELETE' });
        showNotification('Post deleted');
        loadPosts();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    function renderPostTags() {
      const container = document.getElementById('postTagsContainer');
      container.innerHTML = selectedPostTags.map(tagId => {
        const tag = tags.find(t => t._id === tagId);
        return tag ? `
          <span class="tag-chip">
            ${tag.name}
            <button type="button" onclick="removeTagFromPost('${tagId}')">&times;</button>
          </span>
        ` : '';
      }).join('');
    }

    function updateTagSelect() {
      const select = document.getElementById('postTagSelect');
      select.innerHTML = '<option value="">Add tag...</option>' +
        tags.filter(t => !selectedPostTags.includes(t._id))
          .map(t => `<option value="${t._id}">${t.name}</option>`).join('');
    }

    function addTagToPost() {
      const select = document.getElementById('postTagSelect');
      if (select.value && !selectedPostTags.includes(select.value)) {
        selectedPostTags.push(select.value);
        renderPostTags();
        updateTagSelect();
      }
      select.value = '';
    }

    function removeTagFromPost(tagId) {
      selectedPostTags = selectedPostTags.filter(id => id !== tagId);
      renderPostTags();
      updateTagSelect();
    }

    function previewPostCover() {
      const url = document.getElementById('postCoverImage').value;
      const img = document.getElementById('postCoverPreview');
      if (url) {
        img.src = url;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
    }

    function addFaqBlock(question = '', answer = '') {
      const container = document.getElementById('faqContainer');
      const div = document.createElement('div');
      div.className = 'faq-item';
      div.innerHTML = `
        <button type="button" class="remove-faq" onclick="this.parentElement.remove()">&times;</button>
        <div class="form-group">
          <label>Question</label>
          <input type="text" class="faq-question" value="${escapeHtml(question)}" maxlength="500">
        </div>
        <div class="form-group">
          <label>Answer</label>
          <textarea class="faq-answer" rows="2" maxlength="5000">${escapeHtml(answer)}</textarea>
        </div>
      `;
      container.appendChild(div);
    }

    function getFaqData() {
      const items = document.querySelectorAll('.faq-item');
      return Array.from(items).map(item => ({
        question: item.querySelector('.faq-question').value,
        answer: item.querySelector('.faq-answer').value
      })).filter(f => f.question && f.answer);
    }

    // --- CATEGORIES ---
    async function loadCategories() {
      document.getElementById('categoriesLoading').style.display = 'block';
      document.getElementById('categoriesTable').style.display = 'none';
      document.getElementById('categoriesEmpty').style.display = 'none';

      try {
        const { categories: cats } = await apiCall('/api/admin/blog/categories');
        categories = cats;

        // Update filter
        document.getElementById('postCategoryFilter').innerHTML = '<option value="">All Categories</option>' +
          categories.map(c => `<option value="${c._id}">${c.name}</option>`).join('');

        document.getElementById('categoriesLoading').style.display = 'none';

        if (categories.length === 0) {
          document.getElementById('categoriesEmpty').style.display = 'block';
          return;
        }

        document.getElementById('categoriesTable').style.display = 'table';
        const tbody = document.getElementById('categoriesTableBody');
        tbody.innerHTML = categories.map(cat => `
          <tr>
            <td>${escapeHtml(cat.name)}</td>
            <td><code>${cat.slug}</code></td>
            <td>${cat.postsCount}</td>
            <td>${cat.sortOrder}</td>
            <td>
              <div class="action-btns">
                <button class="btn btn-primary btn-sm" onclick="editCategory('${cat._id}')">Edit</button>
                <a href="/blog/category/${cat.slug}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                <button class="btn btn-danger btn-sm" onclick="deleteCategory('${cat._id}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading categories:', err);
        document.getElementById('categoriesLoading').textContent = 'Error loading categories';
      }
    }

    function openCategoryModal(cat = null) {
      document.getElementById('categoryModalTitle').textContent = cat ? 'Edit Category' : 'New Category';
      document.getElementById('categoryId').value = cat?._id || '';
      document.getElementById('categoryName').value = cat?.name || '';
      document.getElementById('categorySlug').value = cat?.slug || '';
      document.getElementById('categoryCoverImage').value = cat?.coverImage || '';
      document.getElementById('categoryCoverImageAlt').value = cat?.coverImageAlt || '';
      document.getElementById('categorySeoTitle').value = cat?.seoTitle || '';
      document.getElementById('categorySeoDescription').value = cat?.seoDescription || '';
      document.getElementById('categorySortOrder').value = cat?.sortOrder || 0;
      categoryDescriptionEditor.root.innerHTML = cat?.description || '';

      document.getElementById('categoryModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    async function editCategory(id) {
      const cat = categories.find(c => c._id === id);
      if (cat) openCategoryModal(cat);
    }

    async function saveCategory() {
      const id = document.getElementById('categoryId').value;
      const data = {
        name: document.getElementById('categoryName').value,
        slug: document.getElementById('categorySlug').value || undefined,
        description: categoryDescriptionEditor.root.innerHTML,
        coverImage: document.getElementById('categoryCoverImage').value,
        coverImageAlt: document.getElementById('categoryCoverImageAlt').value,
        seoTitle: document.getElementById('categorySeoTitle').value,
        seoDescription: document.getElementById('categorySeoDescription').value,
        sortOrder: parseInt(document.getElementById('categorySortOrder').value) || 0
      };

      try {
        if (id) {
          await apiCall(`/api/admin/blog/categories/${id}`, { method: 'PUT', body: JSON.stringify(data) });
        } else {
          await apiCall('/api/admin/blog/categories', { method: 'POST', body: JSON.stringify(data) });
        }
        showNotification('Category saved!');
        closeCategoryModal();
        loadCategories();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('Delete this category?')) return;
      try {
        await apiCall(`/api/admin/blog/categories/${id}`, { method: 'DELETE' });
        showNotification('Category deleted');
        loadCategories();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    // --- TAGS ---
    async function loadTags() {
      document.getElementById('tagsLoading').style.display = 'block';
      document.getElementById('tagsTable').style.display = 'none';
      document.getElementById('tagsEmpty').style.display = 'none';

      try {
        const { tags: t } = await apiCall('/api/admin/blog/tags');
        tags = t;

        document.getElementById('tagsLoading').style.display = 'none';

        if (tags.length === 0) {
          document.getElementById('tagsEmpty').style.display = 'block';
          return;
        }

        document.getElementById('tagsTable').style.display = 'table';
        const tbody = document.getElementById('tagsTableBody');
        tbody.innerHTML = tags.map(tag => `
          <tr>
            <td>${escapeHtml(tag.name)}</td>
            <td><code>${tag.slug}</code></td>
            <td>${tag.postsCount}</td>
            <td>
              <div class="action-btns">
                <button class="btn btn-primary btn-sm" onclick="editTag('${tag._id}')">Edit</button>
                <a href="/tag/${tag.slug}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                <button class="btn btn-danger btn-sm" onclick="deleteTag('${tag._id}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading tags:', err);
        document.getElementById('tagsLoading').textContent = 'Error loading tags';
      }
    }

    function openTagModal(tag = null) {
      document.getElementById('tagModalTitle').textContent = tag ? 'Edit Tag' : 'New Tag';
      document.getElementById('tagId').value = tag?._id || '';
      document.getElementById('tagName').value = tag?.name || '';
      document.getElementById('tagSlug').value = tag?.slug || '';
      document.getElementById('tagCoverImage').value = tag?.coverImage || '';
      document.getElementById('tagCoverImageAlt').value = tag?.coverImageAlt || '';
      document.getElementById('tagSeoTitle').value = tag?.seoTitle || '';
      document.getElementById('tagSeoDescription').value = tag?.seoDescription || '';
      tagDescriptionEditor.root.innerHTML = tag?.description || '';

      document.getElementById('tagModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeTagModal() {
      document.getElementById('tagModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    async function editTag(id) {
      const tag = tags.find(t => t._id === id);
      if (tag) openTagModal(tag);
    }

    async function saveTag() {
      const id = document.getElementById('tagId').value;
      const data = {
        name: document.getElementById('tagName').value,
        slug: document.getElementById('tagSlug').value || undefined,
        description: tagDescriptionEditor.root.innerHTML,
        coverImage: document.getElementById('tagCoverImage').value,
        coverImageAlt: document.getElementById('tagCoverImageAlt').value,
        seoTitle: document.getElementById('tagSeoTitle').value,
        seoDescription: document.getElementById('tagSeoDescription').value
      };

      try {
        if (id) {
          await apiCall(`/api/admin/blog/tags/${id}`, { method: 'PUT', body: JSON.stringify(data) });
        } else {
          await apiCall('/api/admin/blog/tags', { method: 'POST', body: JSON.stringify(data) });
        }
        showNotification('Tag saved!');
        closeTagModal();
        loadTags();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    async function deleteTag(id) {
      if (!confirm('Delete this tag?')) return;
      try {
        await apiCall(`/api/admin/blog/tags/${id}`, { method: 'DELETE' });
        showNotification('Tag deleted');
        loadTags();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    // --- COMMENTS ---
    async function loadComments() {
      const status = document.getElementById('commentStatusFilter').value;

      document.getElementById('commentsLoading').style.display = 'block';
      document.getElementById('commentsTable').style.display = 'none';
      document.getElementById('commentsEmpty').style.display = 'none';

      try {
        const params = new URLSearchParams();
        if (status) params.append('status', status);

        const { comments } = await apiCall(`/api/admin/blog/comments?${params}`);

        document.getElementById('commentsLoading').style.display = 'none';

        if (comments.length === 0) {
          document.getElementById('commentsEmpty').style.display = 'block';
          return;
        }

        document.getElementById('commentsTable').style.display = 'table';
        const tbody = document.getElementById('commentsTableBody');
        tbody.innerHTML = comments.map(c => `
          <tr>
            <td>
              <strong>${escapeHtml(c.authorName)}</strong>
              ${c.authorEmail ? `<br><small style="color: #64748b;">${escapeHtml(c.authorEmail)}</small>` : ''}
            </td>
            <td>
              <div class="truncate" style="max-width: 300px;" title="${escapeHtml(c.content)}">
                ${escapeHtml(c.content)}
              </div>
            </td>
            <td>
              <a href="/blog/${c.postId?.slug}" target="_blank" class="link">${escapeHtml(c.postId?.title || 'Unknown')}</a>
            </td>
            <td>
              <span class="badge ${c.status === 'approved' ? 'badge-success' : c.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                ${c.status}
              </span>
            </td>
            <td>${new Date(c.createdAt).toLocaleString('ru-RU')}</td>
            <td>
              <div class="action-btns">
                ${c.status !== 'approved' ? `<button class="btn btn-success btn-sm" onclick="moderateComment('${c._id}', 'approved')">Approve</button>` : ''}
                ${c.status !== 'hidden' ? `<button class="btn btn-secondary btn-sm" onclick="moderateComment('${c._id}', 'hidden')">Hide</button>` : ''}
                <button class="btn btn-danger btn-sm" onclick="deleteComment('${c._id}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading comments:', err);
        document.getElementById('commentsLoading').textContent = 'Error loading comments';
      }
    }

    async function moderateComment(id, status) {
      try {
        await apiCall(`/api/admin/blog/comments/${id}`, { method: 'PUT', body: JSON.stringify({ status }) });
        showNotification('Comment updated');
        loadComments();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    async function deleteComment(id) {
      if (!confirm('Delete this comment?')) return;
      try {
        await apiCall(`/api/admin/blog/comments/${id}`, { method: 'DELETE' });
        showNotification('Comment deleted');
        loadComments();
        loadStats();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    // --- SETTINGS ---
    async function loadSettings() {
      try {
        const { settings } = await apiCall('/api/admin/blog/settings');
        document.getElementById('settingsTitle').value = settings.title || '';
        document.getElementById('settingsSeoTitle').value = settings.seoTitle || '';
        document.getElementById('settingsSeoDescription').value = settings.seoDescription || '';
        document.getElementById('settingsCoverImage').value = settings.coverImage || '';
        document.getElementById('settingsCoverImageAlt').value = settings.coverImageAlt || '';
        document.getElementById('settingsCanonical').value = settings.canonical || '';
        settingsDescriptionEditor.root.innerHTML = settings.description || '';

        // Preview
        const img = document.getElementById('settingsCoverPreview');
        if (settings.coverImage) {
          img.src = settings.coverImage;
          img.style.display = 'block';
        }
      } catch (err) {
        console.error('Error loading settings:', err);
      }
    }

    async function saveSettings(e) {
      e.preventDefault();
      const data = {
        title: document.getElementById('settingsTitle').value,
        description: settingsDescriptionEditor.root.innerHTML,
        seoTitle: document.getElementById('settingsSeoTitle').value,
        seoDescription: document.getElementById('settingsSeoDescription').value,
        coverImage: document.getElementById('settingsCoverImage').value,
        coverImageAlt: document.getElementById('settingsCoverImageAlt').value,
        canonical: document.getElementById('settingsCanonical').value
      };

      try {
        await apiCall('/api/admin/blog/settings', { method: 'PUT', body: JSON.stringify(data) });
        showNotification('Settings saved!');
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    // --- MEDIA ---
    async function loadMedia() {
      document.getElementById('mediaLoading').style.display = 'block';
      document.getElementById('mediaGrid').style.display = 'none';
      document.getElementById('mediaEmpty').style.display = 'none';

      try {
        const { files } = await apiCall('/api/admin/blog/media');

        document.getElementById('mediaLoading').style.display = 'none';

        if (files.length === 0) {
          document.getElementById('mediaEmpty').style.display = 'block';
          return;
        }

        document.getElementById('mediaGrid').style.display = 'grid';
        document.getElementById('mediaGrid').innerHTML = files.map(f => `
          <div class="media-item">
            <img src="${f.url}" alt="${f.filename}">
            <button class="delete-media" onclick="deleteMedia('${f.filename}')">&times;</button>
            <button class="copy-url" onclick="copyMediaUrl('${f.url}')">Copy URL</button>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading media:', err);
        document.getElementById('mediaLoading').textContent = 'Error loading media';
      }
    }

    async function uploadMedia(e) {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch(`${API_BASE}/api/admin/blog/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` },
          body: formData
        });

        // Check if response is JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Server error. Please re-login.');
        }

        const data = await res.json();
        if (data.success) {
          showNotification('Image uploaded!');
          loadMedia();
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showNotification(err.message, true);
      }
      e.target.value = '';
    }

    async function deleteMedia(filename) {
      if (!confirm('Delete this image?')) return;
      try {
        await apiCall(`/api/admin/blog/media/${filename}`, { method: 'DELETE' });
        showNotification('Image deleted');
        loadMedia();
      } catch (err) {
        showNotification(err.message, true);
      }
    }

    function copyMediaUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        showNotification('URL copied!');
      });
    }

    // Helpers
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Init - validate token before showing dashboard
    (async function init() {
      if (authToken) {
        const isValid = await validateToken();
        if (isValid) {
          showDashboard();
        } else {
          logout();
        }
      }
    })();

    // Close modals on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePostModal();
        closeCategoryModal();
        closeTagModal();
      }
    });
  </script>
</body>
</html>
